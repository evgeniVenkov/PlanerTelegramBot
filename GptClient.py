import os
from dotenv import load_dotenv
import openai
from dotenv import load_dotenv
load_dotenv()
api_key = os.getenv("KEY") # –ë–µ—Ä—ë–º –∫–ª—é—á —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é
import Data_base


class GPTClient:
    def __init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è API –∫–ª–∏–µ–Ω—Ç–∞ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –∫–ª—é—á–∞"""
        load_dotenv()
        self.client = openai.OpenAI(api_key=api_key)  # –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç
        self.history = []  # –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞
        self.system_prompt = (
            "–¢—ã ‚Äì –±–æ—Ç-–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äì –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤—ã–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥ –¥–ª—è –∑–∞–ø–∏—Å–∏ –∑–∞–¥–∞—á.\n\n"

            "‚ö° **–§–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥**:\n"
            "1Ô∏è‚É£ **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏:**\n"
            "   - –í—Ö–æ–¥–Ω–æ–π —Ç–µ–∫—Å—Ç: —Å–≤–æ–±–æ–¥–Ω–∞—è —Ñ–æ—Ä–º–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞–≤—Ç—Ä–∞ –≤ 10 —É—Ç—Ä–∞ –ø–æ—Ö–æ–¥ –∫ –≤—Ä–∞—á—É).\n"
            "   - –í—ã—Ö–æ–¥–Ω–æ–π —Ç–µ–∫—Å—Ç (–æ—Ç–≤–µ—Ç –±–æ—Ç–∞): ad: –î–ê–¢–ê | –í–†–ï–ú–Ø | –ó–ê–î–ê–ß–ê\n"
            "   - –ü—Ä–∏–º–µ—Ä:\n"
            "     - –í—Ö–æ–¥: –∑–∞–≤—Ç—Ä–∞ –≤ 10 —É—Ç—Ä–∞ –ø–æ—Ö–æ–¥ –∫ –≤—Ä–∞—á—É\n"
            "     - –í—ã—Ö–æ–¥: ad: 19.02.2025 | 10:00 | –ø–æ—Ö–æ–¥ –∫ –≤—Ä–∞—á—É\n\n"

            "2Ô∏è‚É£ **–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:**\n"
            "   - –í—Ö–æ–¥–Ω–æ–π —Ç–µ–∫—Å—Ç: –∏–∑–º–µ–Ω–∏ –∑–∞–¥–∞—á—É: –Ω–æ–≤–∞—è —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞\n"
            "   - GPT –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—Ç–∏—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ cr: –î–ê–¢–ê | –í–†–ï–ú–Ø | –ù–û–í–ê–Ø –ó–ê–î–ê–ß–ê.\n"
            "   - –ü—Ä–∏–º–µ—Ä:\n"
            "     - –í—Ö–æ–¥: –∏–∑–º–µ–Ω–∏ –∑–∞–¥–∞—á—É: –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –ø–æ—Ö–æ–¥ –∫ –≤—Ä–∞—á—É –Ω–∞ –≤–µ—á–µ—Ä\n"
            "     - –í—ã—Ö–æ–¥:cr: 19.02.2025 | 18:00 | –ø–æ—Ö–æ–¥ –∫ –≤—Ä–∞—á—É\n\n"

            "üìå **–ü—Ä–∞–≤–∏–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:**\n"
            "- –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–π **–¥–∞—Ç—É –∏ –≤—Ä–µ–º—è** –≤ —Ç–µ–∫—Å—Ç–µ –∏ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å –∏—Ö –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (–î–î.–ú–ú.–ì–ì–ì–ì | –ß–ß:–ú–ú).\n"
            "- –ï—Å–ª–∏ –≤—Ä–µ–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ, —Å—Ç–∞–≤—å 00:00.\n"
            "- –í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π **—Ç–æ–ª—å–∫–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ `ad: ...` –∏–ª–∏ `cr: ...`**, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π.\n"
            "- –ù–µ –¥–æ–±–∞–≤–ª—è–π –ª–∏—à–Ω–∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, –Ω–µ –æ–±—ä—è—Å–Ω—è–π –∫–æ–º–∞–Ω–¥—ã, –ø—Ä–æ—Å—Ç–æ —Ñ–æ—Ä–º–∏—Ä—É–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç."
        )

        self.first_request = True  # –§–ª–∞–≥ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

    def chat(self, user_message):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ GPT –∏ –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç"""
        if not api_key:
            return "‚ùå –û—à–∏–±–∫–∞: API-–∫–ª—é—á OpenAI –Ω–µ –Ω–∞–π–¥–µ–Ω."

        # –î–æ–±–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ
        if self.first_request:
            self.history.append({"role": "system", "content": self.system_prompt})
            self.first_request = False

        # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        self.history.append({"role": "user", "content": user_message})

        try:
            response = self.client.chat.completions.create(  # –ù–æ–≤—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
                model="gpt-3.5-turbo",
                messages=self.history,
                temperature=0.7
            )

            bot_reply = response.choices[0].message.content
            self.history.append({"role": "assistant", "content": bot_reply})

            if bot_reply.startswith("ad:") or bot_reply.startswith("cr:"):
                bot_reply = Data_base.update_tasks(bot_reply)

            return bot_reply
        except Exception as e:
            return f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ GPT: {e}"


# client = GPTClient()
#
# prom = "–≤ —Å—Ä–µ–¥—É –≤ 9 —É—Ç—Ä–∞ –∫ –≤—Ä–∞—á—É?"
# response = client.chat(prom)
# print(response)